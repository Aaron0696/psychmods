---
title: "NUSmodAn"
author: "Aaron0696"
output:
  github_document:
    toc: true
    toc_depth: 2
  html_document:
    fig_align: center
    code_folding: show
    number_sections: true
    highlight: haddock
    theme: yeti
    toc: yes
    toc_float: yes
    df_print: paged
---

# Set Up

```{r setup, warning = FALSE, message = FALSE}
library(semTools)
library(ggplot2)
library(rjson)
library(stringr)
library(DT)
library(psych)
```

# Extract Data

## Bidding Data From `nusmods`

```{r extract, eval = FALSE}
# load bidding data
# calculate loading times
before <- Sys.time()
# read data directly from URL
myjson <- fromJSON(file = url("https://api.nusmods.com/corsBiddingStatsRaw.json"))
# create empty dataframe which will act as a container to be populated with data
mydata <- data.frame()
# for each element in the myjson list, append it to mydata
for(r in 1:length(myjson))
{
  if(myjson[[r]]$Semester == 1 | myjson[[r]]$Semester == 2)
  {
    mydata <- rbind(mydata, myjson[[r]])
  }
  myjson[[r]] <- NA
}
# calculate loading time
after <- Sys.time()
after - before
# remove myjson to free up some RAM
rm(myjson)
# peek at the data
head(mydata)
tail(mydata)
# data struct
str(mydata)
# save
saveRDS(mydata, file = "mydata.RDS")
```

## Load RDS

```{r loadrds}
mydata <- readRDS("mydata.RDS")
```

# Transform Data

```{r transform1, fig.align = 'left'}
# remove unneeded columns
mydata <- mydata[, -grep("Group|StudentAcctType|Faculty", names(mydata))]
# remove non-psychology modules
mydata <- subset(mydata,
                 # only keep rows where module code begins with PL
                 str_detect(mydata$ModuleCode, "^PL"))
# remove core psychology modules, they are PL323[2 to 6], PL1101E, PL2131, PL2132.
# also remove Roots and Wings (PLS8001) and psychology for non-psych students (PLB1201)
mydata <- subset(mydata,
                 !str_detect(mydata$ModuleCode, "PL323[2-6]|PL1101|PL2131|PL2132|PLS|PLB"))

# create new column that indicates the level of the module, based on their module code
# since I removed all the level 1 and level 2 modules in the lines above, technically I dont require the first two
# ifelse conditions, but I'll leave it here as a demonstration.
mydata$Level <- ifelse(str_detect(mydata$ModuleCode, "1[0-9][0-9][0-9]"), "Level 1",
                       ifelse(str_detect(mydata$ModuleCode, "2[0-9][0-9][0-9]"), "Level 2",
                              ifelse(str_detect(mydata$ModuleCode, "3[0-9][0-9][0-9]"), "Level 3",
                                     ifelse(str_detect(mydata$ModuleCode, "4[0-9][0-9][0-9]"), "Level 4", 
                                            "Graduate Module"))))
# crosstabs to doublecheck
xtabs( ~ ModuleCode + Level, 
       data = mydata, subset = NULL)

# transform these columns to numeric
for(r in c("Quota", "Bidders", "LowestBid", "LowestSuccessfulBid", "HighestBid"))
{
  mydata[,grep(r, names(mydata))] <- as.numeric(mydata[,grep(r, names(mydata))])
}
# transform these columns to factors
for(r in c("AcadYear", "Semester", "ModuleCode", "Round", "Level"))
{
  mydata[,grep(r, names(mydata))] <- factor(mydata[,grep(r, names(mydata))])
}
# create new column Bids Per Quota (BpQ)
mydata$BpQ <- with(mydata, Bidders/Quota)
# datatable *htmlwidget
# datatable(mydata, filter = "top", width = 600)
# summary
summary(mydata)
```

# Explore Data

## Univariate Descriptive Statistics

## Univariate Histograms

<details>
  <summary>View Histograms</summary>

```{r explore1, warning = FALSE, eval = TRUE}
# plot the categorical variables
# note: I did not include ModuleCode in this exploratory graph because it has too many levels (83)
for(r in c("AcadYear", "Semester", "Round", "Level"))
{
  cat(paste0("Histogram Of ", r))
  
  plot(
    ggplot(data = mydata, aes_string(x = r, fill = r)) + 
  geom_histogram(stat = "count") + 
  ylab("Count") +
  ggtitle(paste0("Count of ", r)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90, size = 10, vjust = -1),
        axis.title.x = element_blank())
  )
}
```

```{r explore2, warning = FALSE, eval = TRUE}
# plot the continuous variables
for(r in c("Quota", "Bidders", "LowestBid", "LowestSuccessfulBid", "HighestBid", "BpQ"))
{
  cat(paste0("Histogram Of ", r))
  
  plot(
    ggplot(data = mydata, aes_string(x = r, fill = r)) + 
  geom_histogram(bins = 90, fill = "violetred") + 
  ylab("Histogram") +
  ggtitle(paste0("Frequency of ", r)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90, size = 10, vjust = -1),
        axis.title.x = element_text())
  )
}
```

</details>

## Bivariate Plots

<details>
  <summary>View Categorical-Categorical Bivariate Plots</summary>

### Categorical-Categorical

```{r explorecatcat, warning = FALSE, eval = FALSE}
# create vector to loop across
looper <- c("AcadYear", "Semester", "Round", "Level")
for(r in 1:length(looper))
{
  for(i in 1:length(looper))
  {
   # dont do anything if they are the same or the graph has been made before
   if(i == r | i < r)
   {
   } else {
     cat(paste0(looper[r]," ~ ",looper[i]))
     
     # create formula for xtabs
     tempform <- paste0("~ ", looper[r], " + ", looper[i])
     # temp is a dataframe that is only going to exist in this section
     # and overwritten with each loop
     temp <- as.data.frame(xtabs(eval(parse(text = tempform)),
                            data = mydata,
                            subset = NULL))
     plot(
       ggplot(data = temp, aes_string(x = looper[r], y = looper[i], fill = "Freq", label = "Freq")) +
         geom_tile() + 
         geom_text() + 
         scale_fill_gradient(low = "white", high = "violetred") + 
         theme_minimal() + 
         theme(axis.text.x = element_text(angle = 90, size = 10, vjust = -1))
     )
   }
  }
}
```

</details>

<details>
  <summary>View Continuous-Continuous Bivariate Plots</summary>

### Continuous-Continuous

```{r exploreconcon, warning = FALSE, eval = FALSE}
# create vector to loop across
looper <- c("Quota", "Bidders", "LowestBid", "LowestSuccessfulBid", "HighestBid", "BpQ")
for(r in 1:length(looper))
{
  for(i in 1:length(looper))
  {
   # dont do anything if they are the same or the graph has been made before
   if(i == r | i < r)
   {
   } else {
     cat(paste0(looper[r]," ~ ",looper[i]))
     # create formula for lm()
     tempform.std <- paste0("scale(", looper[i],")", " ~ ", "scale(", looper[r], ")")
     tempform <- paste0(looper[i], " ~ ", looper[r])
     # regress to get best fit line
     # standardized
     stdreg <- lm(eval(parse(text = tempform.std)),
               data = mydata)
     # unstandardized
     reg <- lm(eval(parse(text = tempform)),
               data = mydata)
     
     plot(
       ggplot(data = mydata, aes_string(x = looper[r], y = looper[i])) +
         geom_point(color = "violetred", size = 2, alpha = 0.5) +
         theme_classic() + 
         geom_abline(slope = reg$coefficients[2], intercept = reg$coefficients[1], lty = "dashed") + 
         geom_label(aes(x = Inf, y = Inf, label = paste0("Standardized Regression Coefficient = ",
                                                         round(stdreg$coefficients[2],3)),
                        hjust = 1, vjust = 1)) + 
         theme(axis.text.x = element_text(angle = 90, size = 10, vjust = -1))
     )
   }
  }
}


```

</details>

<details>
  <summary>View Continuous-Categorical Bivariate Plots</summary>

### Continuous-Categorical

```{r exploreconcat, warning = FALSE, eval = FALSE}
for(r in c("AcadYear", "Semester", "Round", "Level"))
{
  for(i in c("Quota", "Bidders", "LowestBid", "LowestSuccessfulBid", "HighestBid", "BpQ"))
  {
    cat(paste0(r," ~ ",i))
    # graph
    plot(
      ggplot(data = mydata, aes_string(x = r, y = i, fill = r)) + 
      geom_bar(stat = "identity") + 
      theme_classic() + 
      theme(legend.position = "none",
            axis.text.x = element_text(angle = 90, size = 10, vjust = -1))
    )
  }
}
```

</details>

<details>
  <summary>View Continuous-Module Bivariate Plots</summary>

### By Module

```{r exploremodule, fig.height = 12, warning = FALSE, eval = FALSE}
for(i in c("Quota", "Bidders", "LowestBid", "LowestSuccessfulBid", "HighestBid", "BpQ"))
{
  cat(paste0("ModuleCode"," ~ ",i))
  # graph
  plot(
    ggplot(data = mydata, aes_string(x = "ModuleCode", y = i, fill = "ModuleCode")) + 
      geom_bar(stat = "identity") + 
      theme_classic() + 
      theme(legend.position = "none",
            axis.text.x = element_text(angle = 90, size = 10, vjust = -1)) + 
      coord_flip()
  )
}
```

</details>

# Is It Easier To Bid For Modules With Extremely Early/Late Lectures?

```{r}

```

